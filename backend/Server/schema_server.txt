-- Tạo bảng Building
CREATE TABLE `schema_server`.`building` (
  `building_id` INT NOT NULL AUTO_INCREMENT,
  `name` VARCHAR(255) NOT NULL,
  `location` VARCHAR(500) NOT NULL,
  PRIMARY KEY (`building_id`)
) ENGINE = InnoDB;

-- Tạo bảng Room
CREATE TABLE `schema_server`.`room` (
  `room_id` INT NOT NULL AUTO_INCREMENT,
  `description` TEXT NULL DEFAULT NULL,
  `x_length` REAL NULL DEFAULT NULL,
  `y_length` REAL NULL DEFAULT NULL,
  `building_id` INT NOT NULL,
  PRIMARY KEY (`room_id`),
  CONSTRAINT `fk_room_building`  -- đặt tên ràng buộc ngoại khóa
    FOREIGN KEY (`building_id`)
    REFERENCES `building`(`building_id`)
    ON DELETE RESTRICT
    ON UPDATE RESTRICT
) ENGINE = InnoDB;

-- Tạo bảng registration_ac
CREATE TABLE `schema_server`.`registration_ac` (
  `room_id` INT NOT NULL,
  `ac_id` INT NOT NULL AUTO_INCREMENT,
  PRIMARY KEY (`ac_id`),
  CONSTRAINT `fk_room_id` FOREIGN KEY (`room_id`)
    REFERENCES `room`(`room_id`) ON DELETE RESTRICT ON UPDATE RESTRICT
) ENGINE = InnoDB;

-- Tạo bảng registration_fan
CREATE TABLE `schema_server`.`registration_fan` (
  `room_id` INT NOT NULL,
  `fan_id` INT NOT NULL AUTO_INCREMENT,
  PRIMARY KEY (`fan_id`),
  CONSTRAINT `fk_room_id_fan` FOREIGN KEY (`room_id`)
    REFERENCES `room`(`room_id`) ON DELETE RESTRICT ON UPDATE RESTRICT
) ENGINE = InnoDB;

-- Tạo bảng registration_em
CREATE TABLE `schema_server`.`registration_em` (
  `room_id` INT NOT NULL,
  `em_id` INT NOT NULL AUTO_INCREMENT,
  PRIMARY KEY (`em_id`),
  CONSTRAINT `fk_room_id_em` FOREIGN KEY (`room_id`)
    REFERENCES `room`(`room_id`) ON DELETE RESTRICT ON UPDATE RESTRICT
) ENGINE = InnoDB;

-- Tạo bảng registration_sensor
CREATE TABLE `schema_server`.`registration_sensor` (
  `room_id` INT NOT NULL,
  `sensor_id` INT NOT NULL AUTO_INCREMENT,
  PRIMARY KEY (`sensor_id`),
  CONSTRAINT `fk_room_id_sensor` FOREIGN KEY (`room_id`)
    REFERENCES `room`(`room_id`) ON DELETE RESTRICT ON UPDATE RESTRICT
) ENGINE = InnoDB;

-- Tạo bảng Air Conditioner
CREATE TABLE `schema_server`.`air_conditioner` (
  `id` INT PRIMARY KEY AUTO_INCREMENT,
  `ac_id` INT NOT NULL,
  `set_temp` FLOAT NOT NULL,
  `control_mode` INT NOT NULL,
  `state` INT NOT NULL,
  `time` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `status` INT NOT NULL
) ENGINE = InnoDB;

-- Tạo bảng Fan
CREATE TABLE `schema_server`.`fan` (
  `id` INT PRIMARY KEY AUTO_INCREMENT,
  `fan_id` INT NOT NULL,
  `set_speed` REAL NOT NULL,
  `control_mode` INT NOT NULL,
  `time` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `set_time` INT NOT NULL,
  `status` INT NOT NULL
) ENGINE = InnoDB;

-- Tạo bảng Sensor Node
CREATE TABLE `schema_server`.`sensor_node` (
  `id` INT PRIMARY KEY AUTO_INCREMENT,
  `sensor_id` INT NOT NULL,
  `temp` REAL NOT NULL,
  `wind` REAL NOT NULL,
  `humid` REAL NOT NULL,
  `pm25` INT NOT NULL,
  `status` INT NOT NULL,
  `time` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
) ENGINE = InnoDB;

-- Tạo bảng Energy Measure
CREATE TABLE `schema_server`.`energy_measure` (
  `id` INT PRIMARY KEY AUTO_INCREMENT,
  `em_id` INT NOT NULL,
  `voltage` REAL NOT NULL,
  `current` REAL NOT NULL,
  `frequency` INT NOT NULL,
  `active_power` REAL NOT NULL,
  `power_factor` REAL NOT NULL,
  `time` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `status` INT NOT NULL
) ENGINE = InnoDB;

CREATE TABLE `schema_server`.`user` (
`user_id` INT NOT NULL AUTO_INCREMENT ,
`name` VARCHAR(255) NULL ,
`username` TEXT NOT NULL ,
`password` TEXT NOT NULL ,
`status` INT NOT NULL ,
PRIMARY KEY (`user_id`)) ENGINE = InnoDB;

CREATE TABLE `schema_server`.`pmv_table` (
`pmv_id` INT NOT NULL AUTO_INCREMENT ,
`room_id` INT NOT NULL ,
`met` REAL NOT NULL ,
`clo` REAL NOT NULL ,
`temp` REAL NOT NULL ,
`wind` REAL NOT NULL ,
`pmv_ref` REAL NOT NULL ,
`pmv` REAL NOT NULL ,
`time` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ,
`status` INT NOT NULL ,
PRIMARY KEY (`pmv_id`)) ENGINE = InnoDB;

ALTER TABLE `pmv_table` ADD CONSTRAINT `room_id` FOREIGN KEY (`room_id`)
REFERENCES `room`(`room_id`) ON DELETE RESTRICT ON UPDATE RESTRICT;

CREATE TABLE `schema_server`.`local_weather` (
`lw_id` INT NOT NULL AUTO_INCREMENT ,
`temp` REAL NOT NULL ,
`humid` REAL NOT NULL ,
`wind` REAL NOT NULL ,
`co2` REAL NOT NULL ,
`aqi` INT NOT NULL ,
`time` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ,
PRIMARY KEY (`lw_id`)) ENGINE = InnoDB;

ALTER TABLE `registration_ac`
ADD `x_pos` REAL NOT NULL AFTER `ac_id`,
ADD `y_pos` REAL NOT NULL AFTER `x_pos`;

ALTER TABLE `registration_em`
ADD `x_pos` REAL NOT NULL AFTER `em_id`,
ADD `y_pos` REAL NOT NULL AFTER `x_pos`;

ALTER TABLE `registration_fan`
ADD `x_pos` REAL NOT NULL AFTER `fan_id`,
ADD `y_pos` REAL NOT NULL AFTER `x_pos`;

ALTER TABLE `registration_sensor`
ADD `x_pos` REAL NOT NULL AFTER `sensor_id`,
ADD `y_pos` REAL NOT NULL AFTER `x_pos`;

CREATE TABLE `schema_server`.`registration_gateway` (
`gateway_id` INT NOT NULL AUTO_INCREMENT ,
`room_id` INT NOT NULL ,
`connected` INT NOT NULL ,
`mac` VARCHAR(30) NOT NULL ,
`description` TEXT NOT NULL ,
`x_pos` REAL NOT NULL ,
`y_pos` REAL NOT NULL ,
PRIMARY KEY (`gateway_id`)) ENGINE = InnoDB;

ALTER TABLE `pmv_table` ADD `sensor_id` INT NOT NULL AFTER `room_id`;

ALTER TABLE `registration_fan` ADD `model` TEXT NOT NULL AFTER `y_pos`,
ADD `sensor_link` TEXT NOT NULL AFTER `model`;

ALTER TABLE `registration_ac` ADD `model` TEXT NOT NULL AFTER `y_pos`,
ADD `sensor_link` TEXT NOT NULL AFTER `model`

CREATE TABLE `schema_server`.`fan_device` (
`fan_id` INT NOT NULL ,
`x_pos_device` REAL NOT NULL ,
`y_pos_device` REAL NOT NULL ) ENGINE = InnoDB;

CREATE TABLE `schema_server`.`ac_device` (
`ac_id` INT NOT NULL ,
`x_pos_device` REAL NOT NULL ,
`y_pos_device` REAL NOT NULL ) ENGINE = InnoDB;

ALTER TABLE `registration_ac` ADD `gateway_id` INT NOT NULL;
ALTER TABLE `registration_sensor` ADD `gateway_id` INT NOT NULL;
ALTER TABLE `registration_fan` ADD `gateway_id` INT NOT NULL;
ALTER TABLE `registration_em` ADD `gateway_id` INT NOT NULL;